<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aglet Match: Âè∞ÁÅ£ÁôæÂíå Paiho Special</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Á≤æÁ∞°ÊµÅÊö¢ÂãïÁï´ */
        @keyframes jellyIn { 0% { transform: scale(0); opacity: 0; } 60% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes suctionOut { 0% { transform: scale(1); filter: brightness(1.2); } 100% { transform: scale(0); opacity: 0; } }
        @keyframes powerPulse { 0%, 100% { transform: scale(1); filter: brightness(1) drop-shadow(0 0 10px gold); } 50% { transform: scale(1.1); filter: brightness(1.4) drop-shadow(0 0 20px gold); } }
        
        .item-jelly { animation: jellyIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) both; }
        .item-match { animation: suctionOut 0.4s forwards; }
        .item-selected { border: 3px solid #818cf8 !important; z-index: 50; transform: scale(1.05); }
        .power-up { animation: powerPulse 1.5s infinite; z-index: 10; cursor: pointer; }
        
        .aglet-img { width: 85%; height: 85%; object-fit: contain; pointer-events: none; }
        .glass-ui { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .board-container { background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); overflow: hidden; position: relative; }
        #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 60; }
    </style>
</head>
<body class="board-container text-slate-100 font-sans">
    <canvas id="particle-canvas"></canvas>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        const GRID_SIZE = 8;
        const TYPES = ['01', '02', '03', '04', '05', '06'];
        const COLORS = { '01': '#fbbf24', '02': '#94a3b8', '03': '#f472b6', '04': '#6366f1', '05': '#22c55e', '06': '#334155' };

        // Á≤íÂ≠êÁ≥ªÁµ±ÈÇèËºØ
        let particles = [];
        const createParticles = (x, y, color) => {
            for (let i = 0; i < 15; i++) {
                particles.push({ x, y, color, radius: Math.random() * 3 + 1, velocity: { x: (Math.random()-0.5)*10, y: (Math.random()-0.5)*10 }, life: 1.0, decay: 0.03 });
            }
        };

        const App = () => {
            const [board, setBoard] = useState([]);
            const [score, setScore] = useState(0);
            const [moves, setMoves] = useState(25);
            const [selected, setSelected] = useState(null);
            const [isBusy, setIsBusy] = useState(false);
            const [matchingIds, setMatchingIds] = useState(new Set());

            useEffect(() => {
                const canvas = document.getElementById('particle-canvas');
                const ctx = canvas.getContext('2d');
                const animate = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    particles.forEach((p, i) => {
                        p.velocity.y += 0.2; p.x += p.velocity.x; p.y += p.velocity.y; p.life -= p.decay;
                        ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                        ctx.fillStyle = p.color + Math.floor(p.life * 255).toString(16).padStart(2, '0');
                        ctx.fill();
                        if (p.life <= 0) particles.splice(i, 1);
                    });
                    requestAnimationFrame(animate);
                };
                canvas.width = window.innerWidth; canvas.height = window.innerHeight;
                animate();
            }, []);

            const createItem = useCallback((type = null, special = null) => ({
                id: Math.random().toString(36).substr(2, 9),
                type: type || TYPES[Math.floor(Math.random() * TYPES.length)],
                special: special // 'STRIPE', 'BOMB', 'RAINBOW'
            }), []);

            const initGame = () => {
                let nb = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill());
                for(let r=0; r<GRID_SIZE; r++) {
                    for(let c=0; c<GRID_SIZE; c++) {
                        let it;
                        do { it = createItem(); } while (
                            (c >= 2 && nb[r][c-1].type === it.type && nb[r][c-2].type === it.type) ||
                            (r >= 2 && nb[r-1][c].type === it.type && nb[r-2][c].type === it.type)
                        );
                        nb[r][c] = it;
                    }
                }
                setBoard(nb);
            };

            useEffect(initGame, []);

            const findMatches = (curr) => {
                let matches = new Set();
                let specials = [];

                // Ê™¢Ê∏¨Ê©´ÂêëËàáÁ∏±Âêë (Á∞°ÂåñÊ†∏ÂøÉÈÇèËºØÁ¢∫‰øùÁ©©ÂÆö)
                for (let r = 0; r < GRID_SIZE; r++) {
                    for (let c = 0; c < GRID_SIZE; c++) {
                        // Ê©´ÂêëÊ™¢Ê∏¨
                        if (c < GRID_SIZE - 2 && curr[r][c].type === curr[r][c+1]?.type && curr[r][c].type === curr[r][c+2]?.type) {
                            let matchLen = 3;
                            while(c+matchLen < GRID_SIZE && curr[r][c+matchLen].type === curr[r][c].type) matchLen++;
                            for(let i=0; i<matchLen; i++) matches.add(`${r},${c+i}`);
                            if(matchLen === 4) specials.push({ r, c, type: 'STRIPE', color: curr[r][c].type });
                            if(matchLen >= 5) specials.push({ r, c, type: 'RAINBOW', color: 'RAINBOW' });
                            c += matchLen - 1;
                        }
                    }
                }
                for (let c = 0; c < GRID_SIZE; c++) {
                    for (let r = 0; r < GRID_SIZE; r++) {
                        // Á∏±ÂêëÊ™¢Ê∏¨
                        if (r < GRID_SIZE - 2 && curr[r][c].type === curr[r+1]?.[c].type && curr[r][c].type === curr[r+2]?.[c].type) {
                            let matchLen = 3;
                            while(r+matchLen < GRID_SIZE && curr[r+matchLen][c].type === curr[r][c].type) matchLen++;
                            for(let i=0; i<matchLen; i++) matches.add(`${r+i},${c}`);
                            if(matchLen === 4) specials.push({ r, c, type: 'STRIPE', color: curr[r][c].type });
                            r += matchLen - 1;
                        }
                    }
                }
                return { positions: Array.from(matches).map(s => ({ r: +s.split(',')[0], c: +s.split(',')[1] })), specials };
            };

            const processBoard = async (curr) => {
                const { positions, specials } = findMatches(curr);
                if (positions.length === 0) { setIsBusy(false); return; }

                setIsBusy(true);
                setMatchingIds(new Set(positions.map(p => curr[p.r][p.c].id)));
                setScore(s => s + positions.length * 20);

                // Á≤íÂ≠êÂô¥Áôº
                positions.forEach(p => {
                    const rect = document.getElementById(`cell-${p.r}-${p.c}`)?.getBoundingClientRect();
                    if(rect) createParticles(rect.left+rect.width/2, rect.top+rect.height/2, COLORS[curr[p.r][p.c].type] || '#fff');
                });

                await new Promise(r => setTimeout(r, 400));

                let nb = curr.map(row => row.map(cell => positions.some(p => curr[p.r][p.c] === cell) ? null : cell));
                
                // Ë£ú‰∏äÁâπÊÆäÈÅìÂÖ∑
                specials.forEach(s => { nb[s.r][s.c] = createItem(s.color === 'RAINBOW' ? '01' : s.color, s.type); });

                // ÊéâËêΩ
                for (let c=0; c<GRID_SIZE; c++) {
                    let write = GRID_SIZE - 1;
                    for (let r=GRID_SIZE-1; r>=0; r--) {
                        if (nb[r][c]) { nb[write][c] = nb[r][c]; if(write!==r) nb[r][c]=null; write--; }
                    }
                    for (let r=write; r>=0; r--) nb[r][c] = createItem();
                }
                
                setBoard(nb);
                setMatchingIds(new Set());
                await new Promise(r => setTimeout(r, 500));
                processBoard(nb);
            };

            const handleSwap = async (r, c) => {
                if (isBusy || moves <= 0) return;
                if (!selected) { setSelected({r, c}); return; }

                const dist = Math.abs(selected.r - r) + Math.abs(selected.c - c);
                if (dist === 1) {
                    setIsBusy(true);
                    let nb = board.map(row => [...row]);
                    [nb[selected.r][selected.c], nb[r][c]] = [nb[r][c], nb[selected.r][selected.c]];
                    setBoard(nb);
                    setSelected(null);
                    setMoves(m => m - 1);

                    if (findMatches(nb).positions.length > 0) processBoard(nb);
                    else {
                        await new Promise(r => setTimeout(r, 400));
                        setBoard(board); setIsBusy(false);
                    }
                } else { setSelected({r, c}); }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4">
                    {/* Header */}
                    <div className="w-full max-w-md glass-ui p-6 rounded-[2rem] mb-6 flex justify-between items-center shadow-2xl">
                        <div className="text-center"><p className="text-indigo-400 text-[10px] font-black uppercase">Score</p><p className="text-3xl font-black">{score}</p></div>
                        <div className="text-center"><h1 className="text-xl font-black italic tracking-tighter">Âè∞ÁÅ£ÁôæÂíå Paiho</h1><p className="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Special Combo Edition</p></div>
                        <div className="text-center"><p className="text-emerald-400 text-[10px] font-black uppercase">Moves</p><p className="text-3xl font-black">{moves}</p></div>
                    </div>

                    {/* Game Board */}
                    <div className="glass-ui p-3 rounded-[3rem] relative shadow-[0_25px_60px_rgba(0,0,0,0.6)]">
                        <div className="grid gap-2" style={{ gridTemplateColumns: `repeat(${GRID_SIZE}, 1fr)`, width: 'min(90vw, 420px)', height: 'min(90vw, 420px)' }}>
                            {board.map((row, r) => row.map((it, c) => (
                                <div key={it?.id} id={`cell-${r}-${c}`}
                                     onClick={() => handleSwap(r, c)}
                                     className={`flex items-center justify-center rounded-2xl cursor-pointer transition-all duration-300 w-full h-full relative
                                     ${selected?.r === r && selected?.c === c ? 'item-selected bg-indigo-500/20' : 'bg-slate-800/40'}
                                     ${matchingIds.has(it?.id) ? 'item-match' : 'item-jelly'}
                                     ${it?.special ? 'power-up' : ''}`}>
                                    
                                    {it?.special === 'RAINBOW' ? <span className="text-3xl">üåà</span> :
                                     <img src={`assets/${it?.type}.png`} className="aglet-img" />}
                                    
                                    {it?.special === 'STRIPE' && <div className="absolute inset-0 border-4 border-white/40 rounded-2xl animate-pulse"></div>}
                                    {it?.special === 'BOMB' && <div className="absolute inset-0 bg-orange-500/20 rounded-full animate-ping"></div>}
                                </div>
                            )))}
                        </div>
                        
                        {moves <= 0 && !isBusy && (
                            <div className="absolute inset-0 bg-slate-950/90 flex flex-col items-center justify-center z-[100] rounded-[2.8rem] backdrop-blur-xl">
                                <h2 className="text-5xl font-black text-white mb-10">{score}</h2>
                                <button onClick={() => window.location.reload()} className="px-16 py-5 bg-indigo-600 text-white rounded-full font-black text-lg active:scale-95 transition-transform">RESTART</button>
                            </div>
                        )}
                    </div>
                    
                    {/* Footer */}
                    <div className="mt-12 text-center max-w-xs opacity-70">
                        <p className="text-slate-400 text-[11px] leading-relaxed italic">
                            Experience the precision of <span className="text-indigo-400 font-bold">Âè∞ÁÅ£ÁôæÂíå (Taiwan Paiho)</span>. 
                            Our specialized <span className="text-indigo-400 font-bold">Touch Fastener</span> solutions represent the pinnacle of footwear innovation.
                        </p>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
